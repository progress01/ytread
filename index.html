<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å½±ç‰‡ç­†è¨˜å·¥ä½œç«™ </title>
    <style>
        :root {
            --primary: #2563eb;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --border: #cbd5e1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- é ‚éƒ¨è¨­å®šå€ --- */
        header {
            padding: 10px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .header-row { display: flex; gap: 8px; align-items: center; }

        input[type="text"] {
            flex: 1;
            background: #f8fafc;
            border: 1px solid #94a3b8;
            border-radius: 6px;
            padding: 0 10px;
            font-size: 16px;
            height: 38px;
            outline: none;
        }
        input:focus { background: #fff; border-color: var(--primary); }

        button { font-family: inherit; }

        .btn-load {
            background: var(--primary); color: white; border: none; border-radius: 6px;
            padding: 0 16px; font-weight: bold; cursor: pointer; white-space: nowrap; height: 38px;
        }
        .btn-bgm {
            background: #f472b6; color: white; border: none; border-radius: 6px;
            padding: 0 12px; font-weight: bold; cursor: pointer; white-space: nowrap; height: 38px;
        }

        /* --- ä¸»å…§å®¹å€ --- */
        #main-container { flex: 1; display: flex; overflow: hidden; }

        #video-wrapper {
            background: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .placeholder { color: #94a3b8; text-align: center; padding: 20px;}

        #note-section {
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- ğŸ® å½±ç‰‡æ§åˆ¶åˆ— --- */
        .video-controls {
            padding: 8px;
            background: #f0f9ff;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: center;
            overflow-x: auto; /* æ‰‹æ©Ÿç‰ˆæ©«å‘æ²å‹• */
            white-space: nowrap;
        }
        
        .ctrl-btn {
            background: white;
            border: 1px solid #94a3b8;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            color: #334155;
            box-shadow: 0 2px 0 rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        .ctrl-btn:active { transform: translateY(2px); box-shadow: none; }
        .ctrl-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* å¿«æ·éµæç¤ºå­— */
        .kbd-hint {
            font-size: 10px;
            color: #64748b;
            font-weight: normal;
            margin-left: 3px;
            background: rgba(0,0,0,0.05);
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* é€Ÿåº¦é¸æ“‡ç¾¤çµ„ */
        .speed-group { display: flex; gap: 4px; border-left: 2px solid #e2e8f0; padding-left: 8px; margin-left: 4px; }
        .speed-btn { padding: 6px 8px; font-size: 12px; border: 1px solid #cbd5e1; box-shadow: none; }
        .speed-active { background: #0f172a; color: white; border-color: #0f172a; }

        /* --- ç­†è¨˜å·¥å…·åˆ— --- */
        .toolbar {
            padding: 8px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .action-btn {
            height: 46px; 
            border: 1px solid transparent; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 1px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.1s;
        }
        .action-btn:active { transform: scale(0.97); }
        
        .action-btn .kbd-hint {
            font-size: 9px;
            background: rgba(255,255,255,0.4);
            color: inherit;
            opacity: 0.8;
        }

        .btn-imp { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .btn-que { background: #f5f3ff; color: #7c3aed; border-color: #ddd6fe; }
        .btn-todo { background: #fffbeb; color: #d97706; border-color: #fde68a; }
        .btn-test { background: #ecfdf5; color: #059669; border-color: #a7f3d0; }
        .btn-oth { background: #f1f5f9; color: #475569; border-color: #e2e8f0; }
        .btn-import { background: #e0f2fe; color: #0284c7; border-color: #bae6fd; }
        .btn-copy { background: #1e293b; color: #fff; border: 1px solid #0f172a; }

        .panel { display: none; padding: 10px; background: #f1f5f9; border-bottom: 1px solid var(--border); }
        textarea.panel-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; margin-bottom: 8px; font-family: monospace; }
        .btn-confirm { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; }
        .bg-blue { background: #0284c7; } .bg-pink { background: #ec4899; }

        #status-bar { font-size: 12px; padding: 4px 10px; background: #fffbeb; color: #d97706; text-align: center; display: none; border-bottom: 1px solid #fde68a; }

        textarea#notes {
            flex: 1; width: 100%; padding: 15px; border: none; resize: none;
            font-size: 16px; line-height: 1.6; font-family: monospace; outline: none; cursor: text;
        }
        
        /* åº•éƒ¨æ“ä½œæŒ‡å— */
        .footer-guide { 
            font-size: 12px; color: #64748b; padding: 8px 10px; background: #f8fafc; border-top: 1px solid #e2e8f0; 
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between; align-items: center;
        }
        .key-badge {
            background: #fff; color: #334155; padding: 2px 5px; border-radius: 4px; 
            font-family: monospace; border: 1px solid #cbd5e1; font-weight: bold;
            box-shadow: 0 1px 0 #cbd5e1;
        }

        /* --- RWD è¨­å®š --- */
        
        /* é›»è…¦/å¹³æ¿ç‰ˆ (å¯¬è¢å¹•) */
        @media (min-width: 768px) {
            #video-wrapper { flex: 6; }
            #note-section { flex: 4; border-left: 1px solid var(--border); }
            iframe { width: 100%; height: 100%; }
            .toolbar { grid-template-columns: repeat(7, 1fr); }
            header { flex-direction: row; align-items: center; }
            .header-row { flex: 1; }
        }

        /* æ‰‹æ©Ÿç‰ˆ (çª„è¢å¹•) */
        @media (max-width: 767px) {
            /* ä¸»å®¹å™¨æ”¹ç‚ºç›´å¼ï¼Œå…è¨±æ²å‹• */
            #main-container { flex-direction: column; overflow-y: auto; }
            
            /* å½±ç‰‡å€å¡Šå›ºå®šåœ¨é ‚éƒ¨ (Sticky) */
            #video-wrapper {
                width: 100%; 
                aspect-ratio: 16 / 9; 
                flex: none; 
                position: sticky; /* é—œéµï¼šè®“å½±ç‰‡å¸é™„åœ¨é ‚éƒ¨ */
                top: 0; 
                z-index: 10; 
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
            
            /* ç­†è¨˜å€å¡Šå¡«æ»¿å‰©é¤˜ç©ºé–“ */
            #note-section { flex: 1; min-height: 500px; }
            
            /* å·¥å…·åˆ—èª¿æ•´ï¼šåŒ¯å…¥/åŒ¯å‡ºæŒ‰éˆ•è·¨å…©æ¬„ */
            .btn-import, .btn-copy { grid-column: span 2; }
            
            /* æ‰‹æ©Ÿç‰ˆéš±è—æŒ‰éˆ•å…§çš„å¿«æ·éµæç¤ºï¼Œé¿å…æ“æ“  */
            .action-btn .kbd-hint { display: none; } 
            
            /* åº•éƒ¨æŒ‡å—éš±è—éµç›¤æç¤ºï¼Œåªç•™é›™æ“Šæç¤º */
            .footer-guide div:last-child { display: none; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-row" style="flex:1;">
        <input type="text" id="noteTitle" placeholder="ğŸ“ ç­†è¨˜ä¸»é¡Œ">
        <button class="btn-bgm" onclick="toggleBgmPanel()">ğŸµ BGM</button>
    </div>
    <div class="header-row" style="flex:2;">
        <input type="text" id="urlInput" placeholder="ğŸ”— å½±ç‰‡ç¶²å€">
        <button id="btnLoad" class="btn-load" onclick="detectAndLoad()">è¼‰å…¥</button>
    </div>
</header>

<div id="status-bar" id="statusMsg"></div>

<div id="bgm-panel" class="panel" style="background: #fce7f3;">
    <textarea id="bgm-list" class="panel-input" style="height: 100px;" placeholder="è²¼ä¸Šå¤šé¦– YouTube ç¶²å€ (ä¸€è¡Œä¸€å€‹)..."></textarea>
    <button class="btn-confirm bg-pink" onclick="startBgmLoop()">â–¶ï¸ é–‹å§‹éš¨æ©Ÿ/å¾ªç’°æ’­æ”¾</button>
    <div style="font-size:12px; color:#be185d; margin-top:5px; text-align:right;">
        ğŸ’¡ å–®é¦–ç¶²å€ = å–®æ›²å¾ªç’° | å¤šé¦–ç¶²å€ = éš¨æ©Ÿæ’­æ”¾
    </div>
</div>

<div id="main-container">
    <div id="video-wrapper">
        <div id="player-container" style="width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
            <div class="placeholder"><p>è«‹è¼‰å…¥å½±ç‰‡</p></div>
        </div>
    </div>
    
    <div id="note-section">
        <div class="video-controls">
            <button class="ctrl-btn" onclick="seekVideo(-10)">âª <span class="kbd-hint">Alt+J</span></button>
            <button class="ctrl-btn" onclick="togglePlay()">â¯ï¸ <span class="kbd-hint">Alt+K</span></button>
            <button class="ctrl-btn" onclick="seekVideo(10)">â© <span class="kbd-hint">Alt+L</span></button>
            
            <div class="speed-group">
                <button class="ctrl-btn speed-btn" onclick="setSpeed(0.5, this)">0.5x</button>
                <button class="ctrl-btn speed-btn speed-active" onclick="setSpeed(1, this)">1x</button>
                <button class="ctrl-btn speed-btn" onclick="setSpeed(1.5, this)">1.5x</button>
                <button class="ctrl-btn speed-btn" onclick="setSpeed(2, this)">2x</button>
            </div>
        </div>

        <div class="toolbar">
            <button class="action-btn btn-imp" onclick="insertTag('é‡é»')">
                <span>â— é‡é»</span> <span class="kbd-hint">Alt+1</span>
            </button>
            <button class="action-btn btn-que" onclick="insertTag('ç–‘å•')">
                <span>â“ ç–‘å•</span> <span class="kbd-hint">Alt+2</span>
            </button>
            <button class="action-btn btn-todo" onclick="insertTag('å¾…è¾¦')">
                <span>â˜ å¾…è¾¦</span> <span class="kbd-hint">Alt+3</span>
            </button>
            <button class="action-btn btn-test" onclick="insertTag('æ¸¬è©¦')">
                <span>ğŸ§ª æ¸¬è©¦</span> <span class="kbd-hint">Alt+4</span>
            </button>
            <button class="action-btn btn-oth" onclick="insertTag('å…¶ä»–')">
                <span>ğŸ“ å…¶ä»–</span> <span class="kbd-hint">Alt+5</span>
            </button>
            <button class="action-btn btn-import" onclick="toggleImportPanel()">ğŸ“¥ åŒ¯å…¥</button>
            <button class="action-btn btn-copy" onclick="smartExport()">ğŸ“¤ åŒ¯å‡º</button>
        </div>

        <div id="import-panel" class="panel">
            <textarea id="import-text" class="panel-input" style="height: 100px;" placeholder="è²¼ä¸Šæ™‚é–“è»¸æ–‡å­—..."></textarea>
            <button class="btn-confirm bg-blue" onclick="processImportManual()">ç¢ºèªåŒ¯å…¥</button>
        </div>

        <textarea id="notes" placeholder="é–‹å§‹ä½ çš„å­¸ç¿’...&#10;é›™æ“Šæ™‚é–“ç¢¼ [00:00] å¯è·³è½‰å½±ç‰‡ã€‚"></textarea>
        
        <div class="footer-guide">
            <div>ğŸ’¡ é›™æ“Šæ™‚é–“ç¢¼è·³è½‰</div>
            <div>
                <span class="key-badge">Alt</span> + 
                <span class="key-badge">1~5</span> æ¨™ç±¤
                <span class="key-badge">J</span><span class="key-badge">K</span><span class="key-badge">L</span> æ§åˆ¶
            </div>
        </div>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    let currentPlatform = null; 
    let ytPlayer = null;
    let loadedUrl = ""; 
    let isBgmMode = false;
    let bgmPlaylist = [];

    // --- å…¨åŸŸå¿«æ·éµç›£è½ ---
    document.addEventListener('keydown', function(e) {
        if (e.altKey) {
            let handled = true;
            switch(e.code) {
                case 'KeyJ': seekVideo(-10); break;
                case 'KeyL': seekVideo(10); break;
                case 'KeyK': togglePlay(); break;
                case 'Digit1': case 'Numpad1': insertTag('é‡é»'); break;
                case 'Digit2': case 'Numpad2': insertTag('ç–‘å•'); break;
                case 'Digit3': case 'Numpad3': insertTag('å¾…è¾¦'); break;
                case 'Digit4': case 'Numpad4': insertTag('æ¸¬è©¦'); break;
                case 'Digit5': case 'Numpad5': insertTag('å…¶ä»–'); break;
                default: handled = false;
            }
            if(handled) e.preventDefault();
        }
    });

    function seekVideo(seconds) {
        if (currentPlatform !== 'yt' || !ytPlayer || typeof ytPlayer.getCurrentTime !== 'function') return;
        const currentTime = ytPlayer.getCurrentTime();
        ytPlayer.seekTo(currentTime + seconds, true);
        const msg = seconds > 0 ? `â© å¿«è½‰ ${seconds}ç§’` : `âª å€’é€€ ${Math.abs(seconds)}ç§’`;
        showStatus(msg, "info");
    }

    function togglePlay() {
        if (currentPlatform !== 'yt' || !ytPlayer || typeof ytPlayer.getPlayerState !== 'function') return;
        const state = ytPlayer.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
            ytPlayer.pauseVideo();
            showStatus("â¸ï¸ æš«åœ", "info");
        } else {
            ytPlayer.playVideo();
            showStatus("â–¶ï¸ æ’­æ”¾", "info");
        }
    }

    function setSpeed(rate, btn) {
        if (currentPlatform !== 'yt' || !ytPlayer || typeof ytPlayer.setPlaybackRate !== 'function') return;
        ytPlayer.setPlaybackRate(rate);
        document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('speed-active'));
        if(btn) btn.classList.add('speed-active');
        showStatus(`ğŸš€ é€Ÿåº¦: ${rate}x`, "info");
    }

    document.getElementById('notes').addEventListener('dblclick', function(e) {
        const textarea = e.target;
        const cursorPos = textarea.selectionStart;
        const text = textarea.value;
        const lineStart = text.lastIndexOf('\n', cursorPos - 1) + 1;
        let lineEnd = text.indexOf('\n', cursorPos);
        if (lineEnd === -1) lineEnd = text.length;
        const currentLine = text.substring(lineStart, lineEnd);
        const timeMatch = currentLine.match(/(?:\[)?(\d{1,2}):(\d{2})(?::(\d{2}))?(?:\])?/);

        if (timeMatch) {
            let hours = 0, minutes = 0, seconds = 0;
            if (timeMatch[3]) {
                hours = parseInt(timeMatch[1]);
                minutes = parseInt(timeMatch[2]);
                seconds = parseInt(timeMatch[3]);
            } else {
                minutes = parseInt(timeMatch[1]);
                seconds = parseInt(timeMatch[2]);
            }
            const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
            if (currentPlatform === 'yt' && ytPlayer) {
                ytPlayer.seekTo(totalSeconds, true);
                showStatus(`ğŸš€ è·³è½‰è‡³ ${timeMatch[0]}`, "success");
            }
        }
    });

    async function detectAndLoad() {
        const urlInput = document.getElementById('urlInput');
        const btnLoad = document.getElementById('btnLoad');
        const url = urlInput.value.trim();
        const container = document.getElementById('player-container');
        
        if (!url) { alert("è«‹è¼¸å…¥ç¶²å€"); return; }
        
        // é›¢é–‹ BGM æ¨¡å¼
        isBgmMode = false; 
        closePanel('bgm-panel');
        
        urlInput.blur(); 
        btnLoad.disabled = true; 
        btnLoad.innerHTML = "âŒ›";
        
        // æ¸…ç†èˆŠæ’­æ”¾å™¨
        if(ytPlayer && typeof ytPlayer.destroy === 'function') {
            ytPlayer.destroy();
            ytPlayer = null;
        }

        container.innerHTML = ''; 
        currentPlatform = null; 
        loadedUrl = url; 
        
        const ytId = extractYouTubeID(url); 
        const biliId = extractBilibiliID(url);
        
        if (ytId) {
            currentPlatform = 'yt';
            let ytDiv = document.createElement('div'); 
            ytDiv.id = 'yt-player-slot'; 
            container.appendChild(ytDiv);
            ytPlayer = new YT.Player('yt-player-slot', { 
                height: '100%', 
                width: '100%', 
                videoId: ytId, 
                events: { 
                    'onReady': (e) => e.target.playVideo(), 
                    'onStateChange': onPlayerStateChange 
                } 
            });
            await tryAutoFetchDescription(ytId);
        } else if (biliId) {
            currentPlatform = 'bili';
            const biliEmbedUrl = `https://player.bilibili.com/player.html?bvid=${biliId}&high_quality=1&danmaku=0`;
            container.innerHTML = `<iframe src="${biliEmbedUrl}" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`;
            showStatus("Bilibili ä¸æ”¯æ´å¤–éƒ¨æ§åˆ¶", "warning");
        } else { 
            alert("ç¶²å€ç„¡æ•ˆ"); 
        }
        btnLoad.disabled = false; 
        btnLoad.innerHTML = "è¼‰å…¥";
    }

    function toggleBgmPanel() { closePanel('import-panel'); const p = document.getElementById('bgm-panel'); p.style.display = p.style.display==='block'?'none':'block'; }

    // --- BGM é‚è¼¯ (ä¿®æ­£ç‰ˆ) ---
    function startBgmLoop() {
        const text = document.getElementById('bgm-list').value;
        // éæ¿¾ç©ºè¡Œï¼Œç¢ºä¿æœ‰å…§å®¹
        const urls = text.split('\n').filter(line => line.trim() !== '');
        
        bgmPlaylist = [];
        urls.forEach(u => { 
            const id = extractYouTubeID(u); 
            if(id) bgmPlaylist.push(id); 
        });
        
        if(bgmPlaylist.length === 0){ alert("æ²’æœ‰åµæ¸¬åˆ°æœ‰æ•ˆçš„ YouTube ç¶²å€"); return; }
        
        isBgmMode = true; 
        currentPlatform = 'yt';
        closePanel('bgm-panel');
        
        // ç‚ºäº†é¿å…è¡çªï¼ŒéŠ·æ¯€ä¸¦é‡å»º
        if(ytPlayer && typeof ytPlayer.destroy === 'function') {
            ytPlayer.destroy();
            ytPlayer = null;
        }
        
        document.getElementById('player-container').innerHTML = '<div id="yt-player-slot"></div>';
        
        // é–‹å§‹æ’­æ”¾
        playRandomSong();
    }

    function playRandomSong() {
        if(bgmPlaylist.length === 0) return;
        
        // éš¨æ©ŸæŠ½é¸
        const nextId = bgmPlaylist[Math.floor(Math.random() * bgmPlaylist.length)];
        
        // åˆ¤æ–·æ’­æ”¾å™¨æ˜¯å¦å·²å­˜åœ¨
        if (ytPlayer && typeof ytPlayer.getVideoData === 'function') {
            const currentId = ytPlayer.getVideoData().video_id;

            // å¦‚æœæ˜¯åŒä¸€é¦–æ­Œ (å–®æ›²å¾ªç’°æˆ–é‹æ°£å¥½æŠ½åˆ°ä¸€æ¨£çš„)
            if (currentId === nextId) {
                // ç›´æ¥æ‹‰å› 0 ç§’ï¼Œä¸ç”¨é‡æ–°è¼‰å…¥
                ytPlayer.seekTo(0);
                ytPlayer.playVideo();
                showStatus("ğŸ”‚ å–®æ›²å¾ªç’°ä¸­", "info");
            } else {
                // ä¸åŒæ­Œï¼Œè¼‰å…¥æ–° ID
                ytPlayer.loadVideoById(nextId);
                showStatus("ğŸµ åˆ‡æ›éš¨æ©Ÿ BGM", "info");
            }
        } else {
            // ç¬¬ä¸€æ¬¡æ’­æ”¾ï¼Œå»ºç«‹æ–°æ’­æ”¾å™¨
            ytPlayer = new YT.Player('yt-player-slot', { 
                height: '100%', 
                width: '100%', 
                videoId: nextId, 
                playerVars: { 'autoplay': 1, 'controls': 1 },
                events: { 
                    'onReady': (e) => e.target.playVideo(), 
                    'onStateChange': onPlayerStateChange 
                } 
            });
            showStatus("â–¶ï¸ BGM é–‹å§‹", "success");
        }
    }

    function onPlayerStateChange(event) { 
        // å½±ç‰‡çµæŸä¸”æ˜¯ BGM æ¨¡å¼ -> ä¸‹ä¸€é¦–
        if (event.data === YT.PlayerState.ENDED && isBgmMode) {
            playRandomSong(); 
        }
    }

    // --- å…¶ä»–å·¥å…·å‡½å¼ ---

    async function tryAutoFetchDescription(videoId) {
        showStatus("æ›´æ–°è³‡è¨Šä¸­...", "loading");
        try {
            const res = await fetch(`https://inv.tux.pizza/api/v1/videos/${videoId}`);
            if (!res.ok) throw new Error();
            const data = await res.json();
            document.getElementById('noteTitle').value = data.title;
            const ch = parseTimeline(data.description);
            if(ch && document.getElementById('notes').value.trim()==="") {
                document.getElementById('notes').value = ch + "\n--------------------------------\n";
                showStatus("âœ… ç« ç¯€å·²åŒ¯å…¥", "success");
            } else hideStatus();
        } catch(e) { hideStatus(); }
    }
    
    function showStatus(msg, type) {
        const bar = document.getElementById('status-bar');
        bar.style.display = 'block'; bar.innerText = msg;
        bar.style.background = type==='loading'?'#e0f2fe':(type==='success'?'#ecfdf5':(type==='warning'?'#fffbeb':'#f1f5f9'));
        bar.style.color = type==='loading'?'#0369a1':(type==='success'?'#047857':(type==='warning'?'#b45309':'#64748b'));
        setTimeout(hideStatus, 2000);
    }
    function hideStatus() { document.getElementById('status-bar').style.display = 'none'; }
    function closePanel(id) { document.getElementById(id).style.display = 'none'; }
    
    function parseTimeline(text) {
        const regex = /(\d{1,2}:\d{2}(?::\d{2})?)\s*(.*?)(?=\s*\d{1,2}:\d{2}|$)/gs;
        let match; let result = "\n--------- ğŸ¤– è‡ªå‹•åŒ¯å…¥ç« ç¯€ ---------\n"; let count = 0;
        while ((match = regex.exec(text)) !== null) {
            let content = match[2].trim(); if(content){ result += `[${normalizeTime(match[1])}] ğŸ“Œ ${content}\n`; count++; }
        }
        return count>0?result:null;
    }
    
    function extractYouTubeID(url) { var match = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/); return (match&&match[7].length==11)?match[7]:false; }
    function extractBilibiliID(url) { var match = url.match(/(BV[a-zA-Z0-9]+)/); return match?match[1]:false; }
    
    function insertTag(tag) {
        let p = ""; if(currentPlatform==='yt'&&ytPlayer&&ytPlayer.getCurrentTime) p=`[${formatTime(ytPlayer.getCurrentTime())}] `;
        insertTextAtCursor(`\n${p}[${tag}] `);
    }
    function insertTextAtCursor(text) {
        const t = document.getElementById('notes');
        const s = t.selectionStart; const e = t.selectionEnd;
        t.value = t.value.substring(0,s)+text+t.value.substring(e);
        t.focus(); t.selectionStart=t.selectionEnd=s+text.length;
    }
    function formatTime(s) { var d = new Date(0); d.setSeconds(s); return d.toISOString().substr(11,8); }
    function normalizeTime(t) { const p=t.split(':'); if(p.length===2)return `00:${p[0].padStart(2,'0')}:${p[1].padStart(2,'0')}`; if(p.length===3)return `${p[0].padStart(2,'0')}:${p[1].padStart(2,'0')}:${p[2].padStart(2,'0')}`; return t; }
    
    function toggleImportPanel() { closePanel('bgm-panel'); const p=document.getElementById('import-panel'); p.style.display=p.style.display==='block'?'none':'block'; }
    function processImportManual() {
        const r = parseTimeline(document.getElementById('import-text').value);
        if(r) { document.getElementById('notes').value+=r+"\n"; closePanel('import-panel'); alert("åŒ¯å…¥æˆåŠŸ"); } else alert("æ ¼å¼éŒ¯èª¤");
    }
    function smartExport() {
        const r = document.getElementById('notes').value;
        const t = document.getElementById('noteTitle').value||"æœªå‘½å";
        const d = new Date().toISOString().slice(0,10);
        const c1 = (r.match(/\[é‡é»\]/g)||[]).length;
        const rep = `# ğŸ“ ${t}\n> ğŸ“… ${d}\n> ğŸ”— ${loadedUrl}\n\n## ğŸ“Š çµ±è¨ˆ\n- â— é‡é»ï¼š${c1} å€‹\n\n## ğŸ“‹ å…§å®¹\n---\n${r}\n---`;
        const tmp = document.createElement("textarea"); tmp.value=rep; document.body.appendChild(tmp);
        tmp.select(); document.execCommand("copy"); document.body.removeChild(tmp); alert("åŒ¯å‡ºæˆåŠŸ (å·²è¤‡è£½)");
    }
</script>

</body>
</html>
