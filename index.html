<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¥µé€Ÿç­†è¨˜èˆ‡éŸ³æ¨‚ç«™ (æ”¯æ´é»æ“Šè·³è½‰)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --border: #cbd5e1;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- é ‚éƒ¨è¨­å®šå€ --- */
        header {
            padding: 10px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .header-row { display: flex; gap: 8px; align-items: center; }

        input[type="text"] {
            flex: 1;
            background: #f8fafc;
            border: 1px solid #94a3b8;
            border-radius: 6px;
            padding: 0 10px;
            font-size: 16px;
            height: 38px;
            outline: none;
        }
        input:focus { background: #fff; border-color: var(--primary); }

        .btn-load {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 16px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            height: 38px;
        }
        
        .btn-bgm {
            background: #f472b6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 12px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            height: 38px;
        }

        /* --- ä¸»å…§å®¹å€ --- */
        #main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #video-wrapper {
            background: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .placeholder { color: #94a3b8; text-align: center; padding: 20px;}

        #note-section {
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .toolbar {
            padding: 8px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .action-btn {
            height: 42px;
            border: 1px solid transparent;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.1s;
        }
        .action-btn:active { transform: scale(0.97); }

        .btn-imp { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .btn-que { background: #f5f3ff; color: #7c3aed; border-color: #ddd6fe; }
        .btn-todo { background: #fffbeb; color: #d97706; border-color: #fde68a; }
        .btn-test { background: #ecfdf5; color: #059669; border-color: #a7f3d0; }
        .btn-oth { background: #f1f5f9; color: #475569; border-color: #e2e8f0; }
        .btn-import { background: #e0f2fe; color: #0284c7; border-color: #bae6fd; }
        .btn-copy { background: #1e293b; color: #fff; border: 1px solid #0f172a; }

        .panel {
            display: none;
            padding: 10px;
            background: #f1f5f9;
            border-bottom: 1px solid var(--border);
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        textarea.panel-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
            font-family: monospace;
        }
        
        .btn-confirm {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            color: white;
        }
        .bg-blue { background: #0284c7; }
        .bg-pink { background: #ec4899; }

        #status-bar {
            font-size: 12px;
            padding: 4px 10px;
            background: #fffbeb;
            color: #d97706;
            text-align: center;
            display: none;
            border-bottom: 1px solid #fde68a;
        }

        /* ç­†è¨˜å€æ¨£å¼å„ªåŒ– */
        textarea#notes {
            flex: 1;
            width: 100%;
            padding: 15px;
            border: none;
            resize: none;
            font-size: 16px;
            line-height: 1.6;
            font-family: monospace;
            outline: none;
            cursor: text; /* ç¢ºä¿æ¸¸æ¨™é¡¯ç¤º */
        }
        
        /* æç¤ºå­— */
        .hint-text {
            font-size: 11px;
            color: #94a3b8;
            position: absolute;
            bottom: 5px;
            right: 10px;
            pointer-events: none;
        }

        /* RWD */
        @media (min-width: 768px) {
            #video-wrapper { flex: 6; }
            #note-section { flex: 4; border-left: 1px solid var(--border); }
            iframe { width: 100%; height: 100%; }
            .toolbar { grid-template-columns: repeat(7, 1fr); }
            header { flex-direction: row; align-items: center; }
            .header-row { flex: 1; }
        }

        @media (max-width: 767px) {
            #main-container { flex-direction: column; overflow-y: auto; }
            #video-wrapper {
                width: 100%;
                aspect-ratio: 16 / 9;
                flex: none;
                position: sticky;
                top: 0;
                z-index: 10;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
            #note-section { flex: 1; min-height: 500px; }
            .btn-import, .btn-copy { grid-column: span 2; } 
        }
    </style>
</head>
<body>

<header>
    <div class="header-row" style="flex:1;">
        <input type="text" id="noteTitle" placeholder="ğŸ“ ç­†è¨˜ä¸»é¡Œ">
        <button class="btn-bgm" onclick="toggleBgmPanel()">ğŸµ BGM</button>
    </div>
    <div class="header-row" style="flex:2;">
        <input type="text" id="urlInput" placeholder="ğŸ”— å½±ç‰‡ç¶²å€">
        <button id="btnLoad" class="btn-load" onclick="detectAndLoad()">è¼‰å…¥</button>
    </div>
</header>

<div id="status-bar" id="statusMsg"></div>

<div id="bgm-panel" class="panel" style="background: #fce7f3;">
    <textarea id="bgm-list" class="panel-input" style="height: 100px;" 
        placeholder="åœ¨æ­¤è²¼ä¸Šå¤šé¦– YouTube ç¶²å€ (ä¸€è¡Œä¸€å€‹)&#10;ç¨‹å¼å°‡æœƒéš¨æ©Ÿå¾ªç’°æ’­æ”¾..."></textarea>
    <button class="btn-confirm bg-pink" onclick="startBgmLoop()">â–¶ï¸ é–‹å§‹éš¨æ©Ÿå¾ªç’°</button>
</div>

<div id="main-container">
    <div id="video-wrapper">
        <div id="player-container" style="width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
            <div class="placeholder"><p>è«‹è¼‰å…¥å½±ç‰‡æˆ–é¸æ“‡ BGM</p></div>
        </div>
    </div>
    
    <div id="note-section">
        <div class="toolbar">
            <button class="action-btn btn-imp" onclick="insertTag('é‡é»')">â— é‡é»</button>
            <button class="action-btn btn-que" onclick="insertTag('ç–‘å•')">â“ ç–‘å•</button>
            <button class="action-btn btn-todo" onclick="insertTag('å¾…è¾¦')">â˜ å¾…è¾¦</button>
            <button class="action-btn btn-test" onclick="insertTag('æ¸¬è©¦')">ğŸ§ª æ¸¬è©¦</button>
            <button class="action-btn btn-oth" onclick="insertTag('å…¶ä»–')">ğŸ“ å…¶ä»–</button>
            <button class="action-btn btn-import" onclick="toggleImportPanel()">ğŸ“¥ æ‰‹å‹•åŒ¯å…¥</button>
            <button class="action-btn btn-copy" onclick="smartExport()">ğŸ“¤ åŒ¯å‡º</button>
        </div>

        <div id="import-panel" class="panel">
            <textarea id="import-text" class="panel-input" style="height: 100px;" placeholder="è²¼ä¸Šå½±ç‰‡èªªæ˜æ¬„æ™‚é–“è»¸..."></textarea>
            <button class="btn-confirm bg-blue" onclick="processImportManual()">ç¢ºèªåŒ¯å…¥</button>
        </div>

        <textarea id="notes" placeholder="é–‹å§‹ä½ çš„å­¸ç¿’... &#10;ğŸ’¡ å°æŠ€å·§ï¼šåœ¨æ™‚é–“æˆ³è¨˜ [00:00:10] ä¸Šã€Œé»å…©ä¸‹ã€å¯è·³è½‰å½±ç‰‡"></textarea>
        <span class="hint-text">ğŸ’¡ é›™æ“Šæ™‚é–“ç¢¼è·³è½‰</span>
    </div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
    let currentPlatform = null; 
    let ytPlayer = null;
    let loadedUrl = ""; 
    let isBgmMode = false;
    let bgmPlaylist = [];

    // â˜…â˜…â˜… æ–°å¢ï¼šç›£è½æ»‘é¼ é›™æ“Šäº‹ä»¶ â˜…â˜…â˜…
    document.getElementById('notes').addEventListener('dblclick', function(e) {
        // 1. å–å¾—æ¸¸æ¨™ä½ç½®
        const textarea = e.target;
        const cursorPos = textarea.selectionStart;
        const text = textarea.value;

        // 2. æ‰¾å‡ºæ¸¸æ¨™æ‰€åœ¨çš„é‚£ä¸€è¡Œ
        const lineStart = text.lastIndexOf('\n', cursorPos - 1) + 1;
        let lineEnd = text.indexOf('\n', cursorPos);
        if (lineEnd === -1) lineEnd = text.length;
        
        const currentLine = text.substring(lineStart, lineEnd);

        // 3. ç”¨ Regex æŠ“å–æ™‚é–“æ ¼å¼ [HH:MM:SS] æˆ– [MM:SS]
        // æ”¯æ´æ ¼å¼: [00:00:17] æˆ– 00:00:17
        const timeMatch = currentLine.match(/(?:\[)?(\d{1,2}):(\d{2})(?::(\d{2}))?(?:\])?/);

        if (timeMatch) {
            let hours = 0, minutes = 0, seconds = 0;
            
            if (timeMatch[3]) {
                // æ ¼å¼ HH:MM:SS
                hours = parseInt(timeMatch[1]);
                minutes = parseInt(timeMatch[2]);
                seconds = parseInt(timeMatch[3]);
            } else {
                // æ ¼å¼ MM:SS
                minutes = parseInt(timeMatch[1]);
                seconds = parseInt(timeMatch[2]);
            }

            const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;

            // 4. æ§åˆ¶å½±ç‰‡è·³è½‰
            if (currentPlatform === 'yt' && ytPlayer && typeof ytPlayer.seekTo === 'function') {
                ytPlayer.seekTo(totalSeconds, true);
                showStatus(`ğŸš€ è·³è½‰è‡³ ${timeMatch[0]}`, "success");
            } else {
                showStatus("âš ï¸ åƒ…æ”¯æ´ YouTube è·³è½‰", "warning");
            }
        }
    });


    async function detectAndLoad() {
        const urlInput = document.getElementById('urlInput');
        const btnLoad = document.getElementById('btnLoad');
        const url = urlInput.value.trim();
        const container = document.getElementById('player-container');

        if (!url) { alert("è«‹è¼¸å…¥ç¶²å€"); return; }
        
        isBgmMode = false;
        closePanel('bgm-panel');

        urlInput.blur();
        btnLoad.disabled = true;
        btnLoad.innerHTML = "âŒ›";
        
        container.innerHTML = '';
        currentPlatform = null;
        loadedUrl = url; 

        const ytId = extractYouTubeID(url);
        const biliId = extractBilibiliID(url);

        if (ytId) {
            currentPlatform = 'yt';
            let ytDiv = document.createElement('div');
            ytDiv.id = 'yt-player-slot';
            container.appendChild(ytDiv);

            ytPlayer = new YT.Player('yt-player-slot', {
                height: '100%',
                width: '100%',
                videoId: ytId,
                events: { 
                    'onReady': (e) => e.target.playVideo(),
                    'onStateChange': onPlayerStateChange 
                }
            });
            await tryAutoFetchDescription(ytId);

        } else if (biliId) {
            currentPlatform = 'bili';
            const biliEmbedUrl = `https://player.bilibili.com/player.html?bvid=${biliId}&high_quality=1&danmaku=0`;
            container.innerHTML = `<iframe src="${biliEmbedUrl}" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`;
            showStatus("Bilibili æš«ä¸æ”¯æ´è‡ªå‹•æŠ“å–ã€‚", "info");
        } else {
            alert("ç¶²å€æ ¼å¼ç„¡æ³•è­˜åˆ¥");
        }

        btnLoad.disabled = false;
        btnLoad.innerHTML = "è¼‰å…¥";
    }

    function toggleBgmPanel() {
        closePanel('import-panel');
        const panel = document.getElementById('bgm-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function startBgmLoop() {
        const text = document.getElementById('bgm-list').value;
        const urls = text.split('\n');
        bgmPlaylist = [];
        urls.forEach(u => {
            const id = extractYouTubeID(u);
            if(id) bgmPlaylist.push(id);
        });
        if(bgmPlaylist.length === 0) { alert("ç„¡æ•ˆé€£çµ"); return; }
        isBgmMode = true;
        closePanel('bgm-panel');
        document.getElementById('player-container').innerHTML = '<div id="yt-player-slot"></div>';
        playRandomSong();
        showStatus(`ğŸµ BGM æ¨¡å¼ï¼šå…± ${bgmPlaylist.length} é¦–`, "success");
    }

    function playRandomSong() {
        const nextId = bgmPlaylist[Math.floor(Math.random() * bgmPlaylist.length)];
        if(ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
            ytPlayer.loadVideoById(nextId);
        } else {
            ytPlayer = new YT.Player('yt-player-slot', {
                height: '100%',
                width: '100%',
                videoId: nextId,
                events: { 'onReady': (e) => e.target.playVideo(), 'onStateChange': onPlayerStateChange }
            });
        }
    }

    function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.ENDED && isBgmMode) {
            playRandomSong();
        }
    }

    async function tryAutoFetchDescription(videoId) {
        showStatus("æ›´æ–°è³‡è¨Šä¸­...", "loading");
        const apiUrl = `https://inv.tux.pizza/api/v1/videos/${videoId}`;
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("API Fail");
            const data = await response.json();
            document.getElementById('noteTitle').value = data.title;
            const extractedChapters = parseTimeline(data.description);
            if (extractedChapters) {
                const notes = document.getElementById('notes');
                if(notes.value.trim() === "") {
                    notes.value = extractedChapters + "\n--------------------------------\n";
                    showStatus(`âœ… è‡ªå‹•åŒ¯å…¥ç« ç¯€`, "success");
                }
            } else { hideStatus(); }
        } catch (error) { hideStatus(); }
    }

    function showStatus(msg, type) {
        const bar = document.getElementById('status-bar');
        bar.style.display = 'block';
        bar.innerText = msg;
        if(type === 'loading') { bar.style.background = '#e0f2fe'; bar.style.color = '#0369a1'; }
        else if(type === 'success') { bar.style.background = '#ecfdf5'; bar.style.color = '#047857'; }
        else if(type === 'warning') { bar.style.background = '#fffbeb'; bar.style.color = '#b45309'; }
        else { bar.style.background = '#f1f5f9'; bar.style.color = '#64748b'; }
        setTimeout(() => { hideStatus(); }, 3000);
    }
    function hideStatus() { document.getElementById('status-bar').style.display = 'none'; }
    function closePanel(id) { document.getElementById(id).style.display = 'none'; }

    function parseTimeline(text) {
        const regex = /(\d{1,2}:\d{2}(?::\d{2})?)\s*(.*?)(?=\s*\d{1,2}:\d{2}|$)/gs;
        let match;
        let result = "\n--------- ğŸ¤– è‡ªå‹•åŒ¯å…¥ç« ç¯€ ---------\n";
        let count = 0;
        while ((match = regex.exec(text)) !== null) {
            let content = match[2].trim();
            if (content) { result += `[${normalizeTime(match[1])}] ğŸ“Œ ${content}\n`; count++; }
        }
        return count > 0 ? result : null;
    }
    function extractYouTubeID(url) {
        var match = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
        return (match && match[7].length == 11) ? match[7] : false;
    }
    function extractBilibiliID(url) {
        var match = url.match(/(BV[a-zA-Z0-9]+)/);
        return match ? match[1] : false;
    }
    function insertTag(tagName) {
        let timePrefix = "";
        if (currentPlatform === 'yt' && ytPlayer && typeof ytPlayer.getCurrentTime === 'function') {
            timePrefix = `[${formatTime(ytPlayer.getCurrentTime())}] `;
        }
        insertTextAtCursor(`\n${timePrefix}[${tagName}] `);
    }
    function insertTextAtCursor(text) {
        const textarea = document.getElementById('notes');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = start + text.length;
    }
    function formatTime(seconds) {
        var date = new Date(0); date.setSeconds(seconds);
        return date.toISOString().substr(11, 8);
    }
    function normalizeTime(timeStr) {
        const parts = timeStr.split(':');
        if (parts.length === 2) return `00:${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}`;
        if (parts.length === 3) return `${parts[0].padStart(2, '0')}:${parts[1].padStart(2, '0')}:${parts[2].padStart(2, '0')}`;
        return timeStr;
    }
    function toggleImportPanel() {
        closePanel('bgm-panel');
        const panel = document.getElementById('import-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }
    function processImportManual() {
        const rawText = document.getElementById('import-text').value;
        const result = parseTimeline(rawText);
        if(result) {
            document.getElementById('notes').value += result + "--------------------------------\n";
            closePanel('import-panel');
            alert("åŒ¯å…¥æˆåŠŸï¼");
        } else { alert("ç„¡æ³•è­˜åˆ¥æ ¼å¼"); }
    }
    function smartExport() {
        const rawContent = document.getElementById('notes').value;
        const title = document.getElementById('noteTitle').value.trim() || "æœªå‘½åç­†è¨˜";
        const today = new Date().toISOString().slice(0, 10);
        const url = loadedUrl || "æœªæä¾›ç¶²å€";
        const countImp = (rawContent.match(/\[é‡é»\]/g) || []).length;
        const countQue = (rawContent.match(/\[ç–‘å•\]/g) || []).length;
        const countTodo = (rawContent.match(/\[å¾…è¾¦\]/g) || []).length;
        const countChapter = (rawContent.match(/ğŸ“Œ/g) || []).length;
        const report = `# ğŸ“ ${title}\n> ğŸ“… æ—¥æœŸï¼š${today}\n> ğŸ”— ä¾†æºï¼š${url}\n\n## ğŸ“Š å­¸ç¿’çµ±è¨ˆ\n- ğŸ“Œ ç« ç¯€ï¼š${countChapter} å€‹\n- â— é‡é»ï¼š${countImp} å€‹\n- â“ ç–‘å•ï¼š${countQue} å€‹\n- â˜ å¾…è¾¦ï¼š${countTodo} å€‹\n\n## ğŸ“‹ ç­†è¨˜å…§å®¹\n-----------------------------------\n${rawContent}\n-----------------------------------\nCreated with æ¥µé€Ÿç­†è¨˜`;
        const tempInput = document.createElement("textarea");
        tempInput.value = report;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        alert(`åŒ¯å‡ºæˆåŠŸï¼`);
    }
</script>

</body>
</html>
